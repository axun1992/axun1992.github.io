## Timeline
`Timeline`节点是一个自动随时间流逝对曲线求值的异步执行块。
它内部包含着曲线，曲线横轴是时间，纵轴是输出值。
**在蓝图中，`Timeline`只可用于`Event`，不可用于`Function`内部。（可能是因为它是异步的）**
当在`EventGraph`中创建了一个`Timeline`节点时，将自动生成一个`Timeline`变量。此变量代表节点所用的`Timeline`实例，无法直接删除。双击变量可打开编辑内部的曲线。
一般用法上，连接节点的`Update`输出引脚，并获取其曲线输出引脚。就可以得到基于时间增加的值用于其它用途，例如用来做数据插值的比例。（节点内可创建多条曲线，每条曲线会生成一个输出引脚）
选中曲线的关键点可以设置点两侧线段的连接方式，一般选`Auto`即可形成较流畅的曲线。

## 核心重定向
因路径改变、文件重命名等原因，导致对资源或代码的引用被破坏。可以通过`核心重定向`功能修复引用关系，并随后修复重定向以去除重定向配置。
<!--more-->
配置在项目的`DefaultEngine.ini`文件中，
在`[CoreRedirects]`节中添加，例如下面是一个把旧项目资源迁移到新项目之后的配置：
```ini
[CoreRedirects]
+PackageRedirects=(OldName=“/Script/ChuanSongJiHua”,NewName="/Script/HuaGongChangProj")
+ClassRedirects=(OldName="/Script/ChuanSongJiHua",NewName="/Script/HuaGongChangProj", MatchSubstring=true)
+StructRedirects=(OldName="/Script/ChuanSongJiHua",NewName="/Script/HuaGongChangProj", MatchSubstring=true)
+EnumRedirects=(OldName="/Script/ChuanSongJiHua",NewName="/Script/HuaGongChangProj", MatchSubstring=true)
```
注意：对于类、结构体、枚举的重定向时，可以设置`MatchSubstring=true`，这样会重定向目录下所有类型，不需要单独为每个类型配置。
加上这样的配置之后，之前显示为被破坏的蓝图现在应该可以正常打开了，然后重新保存之后就会修复重定向，不再需要在ini中的配置。
一个自动化的全部重新配置bat脚本可能是这样：
```shell
set UEPath="D:\Program Files\Epic Games\UE_4.27\Engine\Binaries\Win64\UE4Editor.exe"
set ProjPath=F:\work\led_huagongchang\HuaGongChangProj
%UEPath% "%ProjPath%\HuaGongChangProj.uproject" -run=ResavePackages -projectonly
```
`PackageRedirects`仅对资源的重定向起作用。蓝图类或枚举需要用对应的重定向类型。
如果是Plugin，例如叫A，则需要在Plugin的Config目录下建立`DefaultA.ini`文件，并如上述般进行配置。
关于路径：正确的路径可以通过右键资源,点击复制引用来得到。
名称规则：
|类别|规则|
|:-|:-|
|蓝图|`/Game/[相对于Content的路径]`|
|源代码|`/Script/[项目名].[类名]`|
|插件蓝图|`/[插件名]/[相对于插件Content的路径]`|
|插件源代码|`/Script/[插件名].[类名]`|

## 蓝图的多态
两个蓝图之间为继承关系的话，经测试有这些结论：
- 子类重载的函数具有虚函数的行为。
- 对于预设的Event，子类的Event会覆盖父类的同名Event。
- 对于用户自定义Event，子类不能再重新定义，可以直接使用父类Event，具有虚函数行为。

## 材质中向量如何取分量？
对向量使用ComponentMask节点，在节点详细面板中可以设置需要的分量。

## 示例学习-动画基础
### 核心资产类型
动画角色由三种资产组成：骨架、骨架网格、动画。每种资产为特定目标服务。
**骨架资产**本质上是一个层级骨骼名称的列表，不包含蒙皮和骨骼位置数据。它的主要作用是把动画数据从动画映射到骨架网格上。骨架资产也存储可以用来跨骨架网格和动画使用的元数据，例如动画曲线、同步标记和通知。一个骨架资产可以被多个骨骼层级兼容的骨架网格所共享。
**骨架网格**包含一个蒙皮到骨骼层级（与骨架的层级相同）的网格，以及任何关联到网格的数据，例如材质和物理资产引用。
**动画资产**包含动画骨骼的位置数据，可以在任何共享骨架并分配了该动画的骨架网格体上播放。

### 镜向
镜向可以通过一个镜向数据表实现。该数据表包含骨骼与它们的镜向骨骼的映射。它也可以存储动画曲线、同步标记和其它通知的镜向信息。为了产生镜向效果，镜向数据表必须通过`Mirror Pose`节点在动画蓝图中被引用，节点可以被启用或禁用。

### 根运动-它是什么？
根运动是一个描述是否有运动烘焙到根骨骼（层级中第一个，通常位于地面）上的术语。没有根运动是指，在角色移动时根骨骼在原地没动。反之，有根运动时，根骨骼与角色一起移动。

### 根运动-应用
如果一个动画有根运动，根的移动可以被移动组件提取和使用。这种情况下，在动画指定的移动路径上，移动组件和胶囊体可以对碰撞和物理作出反应。如果一个角色需要完成一个复杂移动的行为，例如躲闪和击打反馈，根运动是一个最好的方法来达到精确的移动而没有脚部滑动。

注：在动画资产的资产细节面板中启用根运动。

### 叠加动画
叠加动画是构建其它更精密动画的核心部分之一。当一个动画被叠加播放时，意味着它是被叠加到另一个动画上，而不是取代它。为了一个动画能被叠加，它需要有一个`base pose`。这个叠加的动画计算自身与基础姿势之间的差异，然后叠加到另一个动画之上。

注：动画蓝图的动画图表中使用`Apply Additive`节点

### 混合空间
混合空间是可以在动画图表中被采样的资源，允许基于一个或两个输入的值混合动画（1D或2D混合空间）。动画们被放置到一个网格上，输入值决定网格上的哪个点应该被播放。

注：在动画图表中使用`Blendspace Player`节点引用混合空间资产，并控制输入值。
通过常规资产创建流程来创建混合空间资产，`Animation/Blend Space`是2D的，`Animation/Legacy/Blend Space 1D`是1D的。
在混合空间资产编辑窗口中，通过右下角的资产列表，把动画拖放到网格中。

### 瞄准偏移
瞄准偏移本质上是叠加动画和混合空间的组合。他能够用于把多个叠加动画或姿态混合到一起，然后把结果应用到另一个动画之上。一个常见例子是用于瞄准武器，或者角色环顾。

注：与混合空间类似，需要创建一个瞄准偏移资产，然后用`AimOffset Player`节点播放。
瞄准偏移资产与混合空间资产的原理一样，几个动画之间做混合插值。然后叠加到`AimOffset Player`节点的`Base Pose`输入之上。

### 蒙太奇和插槽
动画蒙太奇是一种资产，它提供了直接通过蓝图或C++播放动画的方法。通过动画蒙太奇，你可以组合多个不同的动画或叠加动画到一个单独的资产，然后你可以分成几段独立播放或者整体播放。你也可以对一个蒙太奇触发事件，执行多种本地或可复制的任务。例如播放声音提示或粒子效，改变玩家值例如子弹数量，甚至在网络游戏中复制根运动（需要启用动画上的根运动）。
插槽是决定在动画图表中从何处注入蒙太奇的节点。如果蒙太奇包含一个叠加动画，它将会在叠加动画之前的任何动画之上播放。否则它将会覆盖任何动画。一个蒙太奇也可以有多个轨道，每个播放在不同的插槽。

注：插槽是蒙太奇资产中轨道的一个属性，在动画图表中，可以通过`Slot`节点引用该插槽，用以将蒙太奇输出的姿态注入到图表中。
在事件图表中通过`Montage Play`节点播放蒙太奇资产。
蒙态奇中的动画是叠加还是覆盖，取决于动画资产的`Additive Settings`中是否设置了叠加。

### 动画蓝图
动画蓝图是控制骨架网格动画的专用蓝图。它包含一个动画图表，你可以在其中执行动画混合或直接控制骨架的骨骼；它还包含一个事件图表，你可以在其中建立控制动画图表的输入和参数的逻辑。动画蓝图用于构建复杂的角色动画系统。

### 混合曲线
几乎所有的混合节点和状态转移可以通过曲线控制混合行为。曲线定义整过混合过程的混合权重。用户可以在一系列的预设曲线选项中选择，也可以使用自定义曲线资产。为了使一个曲线作为混合曲线使用，X和Y轴都应该从0到1。
你可以在混合节点或状态转移细节面板中找到混合曲线选项。

### 混合配置文件
混合配置文件在每个骨骼的基础上修改混合速度。它可以用于加速身体特定部分的混合。
有两种混合配置类型，时间和权重。时间混合配置文件将允许一个骨骼更早的完成混合，基于应用于每个骨骼的分数。如果一个骨骼设置为0.25，它将会在25%的时间内完成混合。权重混合配置文件允许一个骨骼更快的开始混合，但是和其它骨骼在相同的时间点完成混合。一个骨骼设置成5将会以5倍速开始混合。
混合配置文件是在骨架树中建立，应用到混合节点或状态转移细节面板。

注：在骨架窗口左侧的骨骼树面板的顶部有+号可以添加混合配置文件，顶部右侧的齿轮图标可以管理混合配置文件。

### 惯性混合
惯性混合是一种特殊的混合，它会立即停止正在评估的状态或姿态，同时仍然平滑的混合进新的状态或姿态。
混合节点和状态转移都支持惯性混合，但是需要在图表的后续节点有一个`inertilization`节点。

注：在混合节点的细节面板，Transition Type选择惯性混合。

### 混合节点
动画图表中有很多不同类型的混合节点可用，每种有不同类型的输入。

注：都是以Blend开头的节点。

### 状态机
状态机提供一个图形化的方式把骨架网格的动画拆分成一系列的状态。这些状态被转移条件所管理，从一个状态混合到另一个。作为一个工具，它极大简化了骨架网格动画的设计流程，你可以创建一个图表轻易的控制角色在不同的动画间转移，而不需要创建复杂的蓝图脉络。

注：在动画图表中右键选择State Machine创建一个新的状态机。

### 混合空间图表
混合空间图表是新的一种灵活的混合空间，代替现存的分离的混合空间播放器资产，这种混合空间在动画图表中被创建。这种混合空间的优点是之前的采样点仅是序列播放器，现在则是独立的动画图表，可以包含它们自己的混合节点，状态机，层节点等。

注：在动画图表中右键搜索`BlendSpace`相关节点创建混合空间图表，混合空间图表与混合空间资产类似，但是网格上每个关键点都是一个子动画图表，而不仅是一个动画。因此更加灵活。

### 分层
分层的概念是指使用两个或更多单独的动画，在独立的骨骼或身体部分上播放它们。

注：使用`Layered blend per bone`节点进行分层混合，在其细节面板的LayerStep数组中设置每一个Blend Pose的骨骼名和深度，关于Blend Depth网上的说明如下：

> 当 Blend Depth 的取值为 0 到 1 之间的任何数 (包括0和1) 时, 当前的骨骼会完全取代原来的骨骼位置,完全混合进去
当 Blend Depth 的取值为 -1 时 (不建议取其他的负值), 当前的骨骼完全不会影响原来的骨骼位置，即完全不会混合
当 Blend Depth 的取值为 大于1 的任何数时, 随着这个数值的增加, 当前骨骼混合到原骨骼的程度逐渐减小

```c++
const float IncreaseWeightPerDepth = (BranchFilter.BlendDepth != 0) ? (1.f/((float)BranchFilter.BlendDepth)) : 1.f;
```

### 分层蒙太奇
因为蒙太奇可以通过多个插槽一次播放多个动画，一个单独的蒙太奇可以通过使用`Layered blend per bone`节点，在身体两个不同部分播放两个不同动画。




## 动画重定向
定义：在多个蒙皮网格之间复用骨骼动画。

需要先了解的概念：
|概念|说明|
|:-|:-|
|骨架|树形层级的三维空间节点，每个节点代表一个骨骼关节。|
|蒙皮|指定网格顶点的空间位置跟随哪些骨骼节点，以及每个节点的权重。|
|姿态|每个骨骼的位移、旋转、缩放。|
|局部姿态|骨骼相对于父骨骼的位移、旋转、缩放。|
|全局姿态|骨骼在模型坐标系中的位移、旋转、缩放。|
|`Bind Pose`|绑定姿态，也称为T-Pose。是指在制作网格蒙皮到骨架时，骨架中每个骨骼的姿态。|

为什么需要重定向：
动画中包含多个关键帧，每个关键帧包含骨架的一个局部姿态。动画播放时，计算得到骨架的全局姿态并插值到特定时刻，然后根据骨骼位置控制网格顶点位置。

网格顶点与骨骼的相对位置关系由`Bind Pose`确定，在骨骼运动后，结合骨骼位置和顶点与它的相对位置关系，可以得到顶点新的位置。
详细一点来说，顶点与骨骼的相对位置恒定（受单骨骼影响情况下），该相对位置等于`Bind Pose`时顶点在模型坐标系中的位置乘以骨骼矩阵的逆。这个矩阵是与具体的骨架和`Bind Pose`绑定的。

由于不同的蒙皮网格可能使用不同的骨骼，或者使用相同的骨骼但是缩放不同。总之就是`Bind Pose`不同。因此，一个骨骼动画数据不能直接应用到另一个骨骼上，需要对骨骼的位移做处理才能适配新的骨骼尺寸。

两个蒙皮网格使用不同的骨骼的话，需要设置骨骼之间的对应关系，可能还需要调整目标网格的`Bind Pose`。

