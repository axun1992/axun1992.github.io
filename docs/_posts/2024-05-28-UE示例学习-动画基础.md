---
layout: post
title:  "UE示例学习-动画基础"
tags: ue
---
### 核心资产类型
动画角色由三种资产组成：骨架、骨架网格、动画。每种资产为特定目标服务。
**骨架资产**本质上是一个层级骨骼名称的列表，不包含蒙皮和骨骼位置数据。它的主要作用是把动画数据从动画映射到骨架网格上。骨架资产也存储可以用来跨骨架网格和动画使用的元数据，例如动画曲线、同步标记和通知。一个骨架资产可以被多个骨骼层级兼容的骨架网格所共享。
**骨架网格**包含一个蒙皮到骨骼层级（与骨架的层级相同）的网格，以及任何关联到网格的数据，例如材质和物理资产引用。
**动画资产**包含动画骨骼的变换数据，可以在任何共享骨架并分配了该动画的骨架网格体上播放。
<!--more-->
### 镜像
镜像可以通过一个镜像数据表实现。该数据表包含骨骼与它们的镜像骨骼的映射。它也可以存储动画曲线、同步标记和其它通知的镜向信息。为了产生镜像效果，镜像数据表必须通过`Mirror Pose`节点在动画蓝图中被引用，节点可以被启用或禁用。  

#### 实操  
`Mirror Pose`节点输入和输出都是动画姿态，在它的属性面板上通用`Mirror Data Table`字段可以设置镜像数据表。镜像数据表是行类型为`MirrorTableRow`的`DataTable`，其中每一行记录一个骨骼和它的镜像骨骼，都是字符串。

### 根运动-它是什么？
根运动是一个描述是否有运动烘焙到根骨骼（层级中第一个，通常位于地面）上的术语。没有根运动是指，在角色移动时根骨骼在原地没动。反之，有根运动时，根骨骼与角色一起移动。

### 根运动-应用
如果一个动画有根运动，根的移动可以被移动组件提取和使用。这种情况下，在动画指定的移动路径上，移动组件和胶囊体可以对碰撞和物理作出反应。如果一个角色需要完成一个复杂移动的行为，例如躲闪和击打反馈，根运动是一个最好的方法来达到精确的移动而没有脚部滑动。

#### 实操  
在动画资产的资产细节面板中启用根运动。同时，在动画蓝图的类默认的`Root Motion`上设置合适的类型。  

### 叠加动画
叠加动画是构建其它更精密动画的核心部分之一。当一个动画被叠加播放时，意味着它是被叠加到另一个动画上，而不是取代它。为了一个动画能被叠加，它需要有一个`base pose`。这个叠加的动画计算自身与基础姿势之间的差异，然后叠加到另一个动画之上。  

#### 实操  
使用`Apply Additive`节点，它的输入是两个动画姿态和一个混合系数，输出一个动画姿态。最简单的，输入侧连接两个`SequencePlayer`节点（播放动画序列），输出侧连到`Output Pose`。

### 混合空间
混合空间是可以在动画图表中被采样的资源，允许基于一个或两个输入的值混合动画（1D或2D混合空间）。动画们被放置到一个网格上，输入值决定网格上的哪个点应该被播放。  

#### 实操  
使用`Blendspace Player`节点播放混合空间资产，其控制输入值为1或2个float，输出为动画姿态。
通过常规资产创建流程来创建混合空间资产，`Animation/Blend Space`是2D的，`Animation/Legacy/Blend Space 1D`是1D的。
在混合空间资产编辑窗口中，通过右下角的资产列表，把动画拖放到网格中。  
在混合空间资产编辑窗口左侧的`Asset Details`面板中，

### 瞄准偏移
瞄准偏移本质上是叠加动画和混合空间的组合。他能够用于把多个叠加动画或姿态混合到一起，然后把结果应用到另一个动画之上。一个常见例子是用于瞄准武器，或者角色环顾。  

#### 实操  
与混合空间类似，需要创建一个瞄准偏移资产（分为`Anim Offset 1D`和`Anim Offset 2D`），然后用`AimOffset Player`节点播放。  
`AimOffset Player`节点的`Blend Space`字段设置所播放的瞄准偏移资产，它的输入有：瞄准偏移资产的参数、基本动画姿态、与基本动画姿态的混合系数。输出动画姿态。  
瞄准偏移资产与混合空间资产的原理一样，几个动画之间做混合插值。然后叠加到`AimOffset Player`节点的`Base Pose`输入之上。

### 蒙太奇和插槽
动画蒙太奇是一种资产，它提供了直接通过蓝图或C++播放动画的方法。通过动画蒙太奇，你可以组合多个不同的动画或叠加动画到一个单独的资产，然后你可以分成几段独立播放或者整体播放。你也可以对一个蒙太奇触发事件，执行多种本地或可复制的任务。例如播放声音提示或粒子效，改变玩家值例如子弹数量，甚至在网络游戏中复制根运动（需要启用动画上的根运动）。
插槽是决定在动画图表中从何处注入蒙太奇的节点。如果蒙太奇包含一个叠加动画，它将会在叠加动画之前的任何动画之上播放。否则它将会覆盖任何动画。一个蒙太奇也可以有多个轨道，每个播放在不同的插槽。

#### 实操  
在**事件图表**中通过`Montage Play`节点播放蒙太奇资产。  
在**动画图表**的动画姿态流中插入`Slot`节点来承接注入的蒙太奇姿态，`Slot`节点的细节面板中可以设置`Slot Name`，也可以增删Slot和Group。**插槽和组的定义是保存在骨架资产里的**。  
在蒙太奇资产中，每个轨道分配一个插槽，第一个轨道的组-插槽决定了整个蒙太奇的组，新建的轨道于是只能分配该组下的插槽。
蒙态奇中的动画是叠加还是覆盖，取决于动画资产的`Additive Settings`中`Additive AnimType`是否设置了叠加。  
因此`Slot Name`是联结动画蓝图和蒙太奇资产的一个标记，蒙太奇中的轨道与动画蓝图中的Slot节点通过`Slot Name`对应起来。  

### 动画蓝图
动画蓝图是控制骨架网格动画的专用蓝图。它包含一个动画图表，你可以在其中执行动画混合或直接控制骨架的骨骼；它还包含一个事件图表，你可以在其中建立控制动画图表的输入和参数的逻辑。动画蓝图用于构建复杂的角色动画系统。  

#### 实操
动画图表的核心是在各种节点之间传递动画姿态，每个节点对动画姿态做一定的修改、控制，最后输出最终的动画姿态。  
事件图表与动画图表共享成员变量，事件图表通过常规逻辑控制成员变量，动画图表中的节点也可以将这些成员变量用作输入。另外，事件图表通过播放蒙太奇额外注入动画姿态到动画图表。  

### 混合曲线
几乎所有的混合节点和状态转移可以通过曲线控制混合行为。曲线定义整过混合过程的混合权重。用户可以在一系列的预设曲线选项中选择，也可以使用自定义曲线资产。为了使一个曲线作为混合曲线使用，X和Y轴都应该从0到1。
你可以在混合节点或状态转移细节面板中找到混合曲线选项。  

#### 实操
在混合类节点的细节面板上`Blend Type`小节下有各种混合曲线相关的设置。  
在动画状态机的状态转移线的细节面板上`Blend Setting`小节下有各种混合曲线相关的设置。  

### 混合配置文件
混合配置文件在每个骨骼的基础上修改混合速度。它可以用于加速身体特定部分的混合。
有两种混合配置类型，时间和权重。时间混合配置文件将允许一个骨骼更早的完成混合，基于应用于每个骨骼的分数。如果一个骨骼设置为0.25，它将会在25%的时间内完成混合。权重混合配置文件允许一个骨骼更快的开始混合，但是和其它骨骼在相同的时间点完成混合。一个骨骼设置成5将会以5倍速开始混合。
混合配置文件是在骨架树中建立，应用到混合节点或状态转移细节面板。  

#### 实操
用途是在整个动画混合过程中，让身体的一部分更快的完成混合，达到目标状态。  
设置的方式与混合曲线在类似的地方。  
在骨架窗口左侧的骨骼树面板：顶部有+号可以添加混合配置文件，顶部右侧的齿轮图标可以管理混合配置文件。  

### 惯性混合
惯性混合是一种特殊的混合，它会立即停止正在评估的状态或姿态，同时仍然平滑的混合进新的状态或姿态。
混合节点和状态转移都支持惯性混合，但是需要在图表的后续节点有一个`inertilization`节点。

#### 实操
在混合节点的细节面板，Transition Type选择惯性混合。  
用途理解：在惯性混合时，它不再求值源动画姿态，而是取用其骨骼的变换、速度、加速度，与目标动画姿态进行混合。我理解它的构成可能是：目标姿态+惯性修正。  

### 混合节点
动画图表中有很多不同类型的混合节点可用，每种有不同类型的输入。

#### 实操
都是以Blend开头的节点。

### 状态机
状态机提供一个图形化的方式把骨架网格的动画拆分成一系列的状态。这些状态被转移条件所管理，从一个状态混合到另一个。作为一个工具，它极大简化了骨架网格动画的设计流程，你可以创建一个图表轻易的控制角色在不同的动画间转移，而不需要创建复杂的蓝图脉络。

#### 实操
在动画图表中右键选择State Machine创建一个新的状态机。在状态机中，每个状态输出一个动画姿态，状态内部则很自由，可以任意编写逻辑。

### 混合空间图表
混合空间图表是新的一种灵活的混合空间，代替现存的分离的混合空间播放器资产，这种混合空间在动画图表中被创建。这种混合空间的优点是之前的采样点仅是序列播放器，现在则是独立的动画图表，可以包含它们自己的混合节点，状态机，层节点等。

#### 实操
在动画图表中右键搜索`BlendSpace`相关节点创建混合空间图表，混合空间图表与混合空间资产类似，但是网格上每个关键点都是一个子动画图表，而不仅是一个动画。因此更加灵活。

### 分层
分层的概念是指使用两个或更多单独的动画，在独立的骨骼或身体部分上播放它们。

#### 实操
使用`Layered blend per bone`节点进行分层混合，该节点输入两个动画姿态，输出一个动画姿态。在其细节面板的`LayerStep`数组中设置每一个Blend Pose的骨骼名和深度，关于Blend Depth网上的说明如下：

> 当 Blend Depth 的取值为 0 到 1 之间的任何数 (包括0和1) 时, 当前的骨骼会完全取代原来的骨骼位置,完全混合进去
当 Blend Depth 的取值为 -1 时 (不建议取其他的负值), 当前的骨骼完全不会影响原来的骨骼位置，即完全不会混合
当 Blend Depth 的取值为 大于1 的任何数时, 随着这个数值的增加, 当前骨骼混合到原骨骼的程度逐渐减小

```c++
const float IncreaseWeightPerDepth = (BranchFilter.BlendDepth != 0) ? (1.f/((float)BranchFilter.BlendDepth)) : 1.f;
```

### 分层蒙太奇
因为蒙太奇可以通过多个插槽一次播放多个动画，一个单独的蒙太奇可以通过使用`Layered blend per bone`节点，在身体两个不同部分播放两个不同动画。

#### 实操
其实还是普通的事件图表播放蒙太奇，注入到动画图表的插槽中。只不过因为可以同时多个插槽注入，每个注入的姿态还可以通过`Layered blend per bone`节点进行分层混合。