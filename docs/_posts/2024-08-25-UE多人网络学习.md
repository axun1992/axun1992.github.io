---
layout: post
title:  "UE多人网络学习"
tags: ue
---
在多人游戏会话中，游戏状态信息将通过网络连接在多台计算机之间传达。虚幻引擎（UE） 提供的网络框架非常强大，支持着世界上最流行的一些在线多人游戏，可帮助你简化此过程。
<!--more-->
# 虚幻引擎网络概述
服务器作为游戏主机保存一个真正的 权威 游戏状态。换句话说，服务器是多人游戏实际运行的地方。  
客户端各自控制它们在服务器上拥有的远程 Pawn 。客户端从其本地Pawn向其服务器Pawn发送 远程程序调用 以在游戏中执行操作。  
接着，服务器向每个客户端 复制 关于游戏状态的信息，例如 Actor 所在的位置，这些Actor应该具备怎样的行为，以及不同的变量应该有哪些值。然后每个客户端使用这些信息，近似模拟服务器上实际正在发生的情况。  
  
此过程在
- 基础Gameplay交互（碰撞、移动、损伤）
- 美化效果（视觉效果和声音）
- 玩家信息（HUD更新）

之间进行了划分。这三者各自与网络中的特定计算机或一组计算机关联。    
网络模式宏与构建目标的关系：  
|Target|UE_SERVER|WITH_SERVER_CODE|
|:-|:-|:-|
|Game|0|1|
|Server|1|1|
|Client|0|0|
  
  
复制是指权威服务器将状态数据发送到连接的客户端的过程。主要使用Actor和Actor派生的类通过UE中的网络连接复制其状态。  
AActor 是可以在关卡中放置或生成的对象的基类，也是UE的 UObject 继承层级中第一个支持用于网络的类。UObject 派生的类也可以复制，但必须作为复制的子对象附加到Actor才能恰当复制。  
默认情况下，大部分Actor不会复制，而是在本地执行其函数。你可以将C++中的 bReplicates 变量或蓝图中的 Replicates 设置设为 true ，为Actor派生的类启用复制。  
可用的不同复制功能：  

|功能|说明|
|:-:|:-|
|创建和销毁|服务器上生成可复制Actor的权威版本时，会在所有连接的客户端上生成远程代理。接着会将信息复制到这些远程代理。销毁权威Actor将自动销毁所有连接的客户端上的远程代理。|
|移动|Actor需启用bReplicateMovement|
|属性|Actor需重载GetLifetimeReplicatedProps函数，DOREPLIFETIME(ADerivedActor, Health);（看来是简单类型）|
|组件|组件需设为复制|
|子对象|从UObject派生的类，重载ReplicateSubobjects或使用注册子对象列表|
|远程程序调用|无论初始在哪台计算机上调用RPC，其实现将仅在目标计算机上运行|
  
创建、销毁、移动等常见用例会自动处理，但其他所有Gameplay功能在默认情况下不会复制，即使你为Actor启用复制也是如此。你必须手动指定。

网络编程法则：  
- 少用RPC，尽量用Replicated Using (RepNotify) property。
- 少用multicast函数。
- 仅服务器的逻辑如果可以保证在服务器上执行，则不需要放在Server RPC中。
- 当关联用户输入和Reliable RPCs时需警慎并限制频率，以避免可靠远程调用的栈溢出。
- 对经常调用的函数使用不可靠RPC。
- 尽量复用函数，同时被游戏逻辑和RepNotifies调用，以保证在客户端和服务器并行执行。
- 检查actor的网络角色，以过滤执行函数。
- 通过IsLocallyControlled来检查pawn是否是本地控制的。
- 使用网络休眠，这是最有效的优化之一。  
  
# 多人游戏中的关卡转移
有三个用来驱动转移的主要函数：  
|函数|说明|
|:-|:-|
|UEngine::Browse|非无缝加载|
|UWorld::ServerTravel|服务器使用|
|APlayerController::ClientTravel|客户端使用，也会在服务器转移时被自动调用|
  
# 详细的Actor复制流程
@todo