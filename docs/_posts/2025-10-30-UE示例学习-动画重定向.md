---
layout: post
title:  "UE示例学习-动画重定向"
tags: ue
---
动画重定向提供了在不同的角色之间复用动画的能力，无论它们的比例和骨骼层级如何。  
通过使用位移重定向、IK绑定和IK重定向器，重定向处理既可以在运行时实施，也可以离线创建新的动画资产。 
<!--more-->
**友情提示，学习此篇需要先学习IK Rig**  

### 平移重定向
在使用相同骨架(缩放可能不同)的角色间重定向动画。
#### 实操 
原理说明：  
动画绑定到骨架资源。骨架资产其实就是一个骨骼名称和层次结构数据的列表，但它也存储了来自用于定义骨架资产的原始骨骼网格的初始比例。此数据是以骨骼平移数据的形式存储的。特别要注意的是，重定位系统只会重定位骨骼的平移分量。骨骼的旋转始终来自动画数据。 

步骤：  

1. 打开动画所关联的骨架资源。  
2. 在骨架树窗口的设置中，打开`Show Retargeting Options`复选框。  
3. 右键Root骨骼，选择`Recursively Set Translation Retargeting Skeleton`。  
4. 找到骨盆(Pelvis)，设为`AnimationScaled`。  
5. 找到Root、IK之类的骨骼，设为`Animation`。  
6. 预览方面，可以修改预览设置中所用的网格、可以在视口显示中打开骨骼所有层级、未重定向动画。来预览重定向效果和对比重定向骨骼。  

为什么Pelvis要设为`AnimationScaled`，而其它身体骨骼设为`Skeleton`就可以？  
`Skeleton`模式时骨骼平移来自于目标骨架，常规动画不会改变骨骼长度，因此用骨架默认的骨骼平移也就行了。但是Pelvis是身体的第一根骨骼，它连接的Root实质代表地面支点。因此动画是会修改Pelvis的骨骼长度的。如果也设为`Skeleton`，就失去了动画中可能存在的运动时角色的高低起伏了。

三种重定向方式：  

. **Animation** 骨骼平移来自动画数据，不做改变。  
. **Skeleton** 骨骼平移来自目标骨架的绑定姿势。  
. **AnimationScaled** 骨骼平移来自动画数据，但按骨架的比例调整。这是目标骨架（播放动画的骨架）与源骨架（制作动画的骨架）的骨骼长度之比。  

### 从网格复制姿态
在相似的骨架间复制动画
#### 实操 
在动画蓝图的动画图表中，使用`Copy Pose From Mesh`节点，来从另一个蒙皮网格上复制姿态数据，前提是两者的骨骼层级一致。如果源网格是目标网格的父级，此节点可以钩选`Use Attached Parent`。  

### 重定向人体模型
使用IK绑定和IK重定向器，在两个人体模型间重定向。
#### 实操
首先的，在目标动画图表中，使用了`Retarget Pose From Mesh`节点，来从源网格复制动画，该节点需设置源网格和IK重定向器。  
（使用此节点意在展示运行时重定向，因为没有导出重定向后新的动画资产，可以用于运行时两个角色网格显隐切换，但复用同一个动画）  
重点在于IK重定向器，这是一种可创建的资产，在它的细节面板中可以设置源和目标IK绑定。它的作用是关联映射两个IK绑定资产，还可以设置重定向时的姿态。（两个网格姿态相似，重定向效果才会好）  
更进一步的，是IK绑定，IK绑定也是一种可创建的、依赖具体骨架的资产，重定向只使用它的创建骨骼链的功能，每个骨骼链标识了一段骨骼层级。两个IK绑定创建相同的骨骼链后，可用于重定向。
重定向效果调好后，可以在重定向器的`Asset Browser`中选择动画导出，成为新的重定向动画，这也即是离线重定向。  

### 在不同骨架间重定向
使用IK Rig（IK绑定）和IK Retargeter（IK重定向器）进行重定向。
#### 实操
和上面类似，但是在重定向器里，创建了新的目标姿态，并编辑了骨骼参数以调整到相似姿态。  
另外UE5.6的重定向器新增了个Op Stack，还不理解。  

### 重定向的阶段
重定向根->FK重定向->IK重定向  
首先，它向重定向的根传递运动。然后，它在所有映射的骨骼链上进行插值的FK重定向。最后，从IK绑定中的IK解算器上应用IK重定向。
#### 实操
从示例可以看出，上述步骤对应着Op Stack中的各个执行块。  

1. **Pelvis Motion** &emsp;&emsp;&emsp;重定向根
2. **Retarget FK Chains** &emsp;&emsp;&emsp;FK重定向
6. **Run IK Rig** &emsp;&emsp;&emsp;好像是一个组
3. **Retarget IK Goals** &emsp;&emsp;&emsp;IK重定向步骤
4. **Stride Warp IK Goals** &emsp;&emsp;&emsp;IK重定向步骤-步伐扭曲功能，这允许操控重定向的动画的步幅长度、宽度和外翻度。步幅扭曲要求你使用重定向的IK目标来设置角色。
5. **Speed Plant IK Goals** &emsp;&emsp;&emsp;速度栽植工作流程解决滑步问题。
7. **Pole Vector Alignment** &emsp;&emsp;&emsp;极矢量对齐，控制目标链的扭曲。

基本上，Op Stack就是以前的全局设置和链设置。细节还有待进一步学习。  


### 重定向姿态
摆放角色的姿态以适合重定向。
#### 实操
在重定向器的层级窗口可以创建新的姿态，并编辑骨骼以适配源姿态。  
在Op Stack的`Retarget IK Goals`模块中，可以选中某个目标链，并调整其混合与偏移。  

### 编辑重定向根
调节重定向的根，使重定向的动画更高或者更底。
#### 实操
本质上，就是修改`Op Stack`中的`Pelvis Motion`执行块中的属性。  
具体来说，调节重定向根的高度的话，就是修改其`Translation Offset`的`Z`。  
不过，也是可以通用Actor的蓝图来修改的，步骤如下：  

1. 使用`Copy Retarget Profile from Retarget Asset`节点从重定向器资产中复制`Retarget Profile`。
2. 使用`Get Op Controller from Retarget Profile`节点从`Retarget Profile`中获取`Op Controller`，指定名字为`Pelvis Motion`以获取重定向根阶段的`Controller`。
3. `Make Pelvis Motion Settings`并设定`Translation Offset`的`Z`后，设置`Controller`。这样会间接的更新到`Retarget Profile`。
4. 把`Retarget Profile`传递进`Anim Instance`，动画图表中的`Retarget Pose From Mesh`节点使用该`Retarget Profile`实时覆盖重定向器中的设置。


### 保持接触点
固定目标IK目标到源骨骼的末梢骨骼位置，使重定向的动画步幅更接近源动画。
#### 实操
和上面例子类似，也是从重定向器中获取`Op Stack`中对应执行块的`Op Controller`，并使用它更新设置，再通过动画蓝图中的动画图表节点设回`Profile`，实时覆盖重定器中的设置值。  
在这里，获取`Op Controller`传入的名称是`Retarget IK Goals`，然后获取`Controller`的Setting，是`Retarget IKChain Settings`数组。  
找到左、右腿的IKChain后，修改其`Blend To Source`的数值，1的话就是和源一致了。  
然后设回到`Op Controller`，再然后把`Retarget Profile`传递进`Anim Instance`。  

### 调整步伐
缩放步伐的长度和宽度。
#### 实操
依然和上面类似，只列出一些关联点：  

1. 获取`Op Controller`传入的名称是`Stride Warp IK Goals`
2. `Op Controller`的`Setting`中，修改`Warp Splay`属性

`Warp Splay`的范围是0到正无穷，小于1会使目标向平均位置靠拢，大于1会使目标互相远离。  

### 速度栽植
基于生成的速度曲线栽植IK目标，以解决滑步。 

列出一些关联点：  

1. 获取`Op Controller`传入的名称是`Speed Plant IK Goals`
2. `Op Controller`的`Setting`中，修改`Chains To Speed Plant`属性


另外，这项技术的另一个重要步骤，是从源动画中创建足部的位移动画曲线。

1. 在原动画序列中，`Window`->`Animation Data Modifiers`打开工具窗口。
2. `Add Modifier`->`MotionExtractorModifier`新建运动数据提取器，设置好骨骼名、运动类型、轴向。类型是`Translation`，轴向是`XYZ`。依此方式为两足创建。
3. 点击`Apply All Modifiers`生成曲线。

#### 实操
在`Chains To Speed Plant`属性中，需指定曲线名、速度阈值、劲度系数、阻尼系数。  
它的原理是基于动画曲线提供的当前速度值和设定的参数，决定IK目标是要移动还是固定。  
**速度阈值**会抑制骨骼的动画速度低于它时的运动，也就是所谓的栽植。  
**劲度系数**和**阻尼系数**构成一个弹簧模型，控制当未栽植时IK目标的位移更平滑。  

### 重定向后处理-钉住骨骼
在重定向的结果之上钉住骨骼。  

#### 实操
在IK重定向器的`Op Stack`的最后面，添加一个新的`Pin Bones`阶段，该阶段可以指定骨骼映射对。  
这实质是让除了IK绑定链的映射之外，其它骨骼也有机会锚定一起运动。  

### 重定向后处理-根运动
从重定向动画中产生新的根运动。

#### 实操
在IK重定向器的`Op Stack`的最后面，添加一个新的`Root Motion`阶段，该阶段可以指定骨骼根映射、根运动骨骼映射等。  

### 重定向后处理-重映射曲线
IK重定向器中的重映射曲线。

#### 实操
在IK重定向器的`Op Stack`的最后面，添加一个新的`Remap Curves`阶段，该阶段可以指定曲线映射。曲线定义在源、目标网格体上。  