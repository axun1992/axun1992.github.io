---
layout: post
title:  "UE示例学习-动画基础"
tags: ue
---
动画重定向提供了在不同的角色之间复用动画的能力，无论它们的比例和骨骼层级如何。  
通过使用位移重定向、IK绑定和IK重定向器，重定向处理既可以在运行时实施，也可以离线创建新的动画资产。 
<!--more-->
### 平移重定向
在使用相同骨架(缩放可能不同)的角色间重定向动画。
#### 实操 
原理说明：  
动画绑定到骨架资源。骨架资产其实就是一个骨骼名称和层次结构数据的列表，但它也存储了来自用于定义骨架资产的原始骨骼网格的初始比例。此数据是以骨骼平移数据的形式存储的。特别要注意的是，重定位系统只会重定位骨骼的平移分量。骨骼的旋转始终来自动画数据。 

步骤：  

1. 打开动画所关联的骨架资源。
2. 在骨架树窗口的设置中，打开`Show Retargeting Options`复选框。
3. 右键Root骨骼，选择`Recursively Set Translation Retargeting Skeleton`。
4. 找到骨盆(Pelvis)，设为`AnimationScaled`。
5. 找到Root、IK之类的骨骼，设为`Animation`。
6. 预览方面，可以修改预览设置中所用的网格、可以在视口显示中打开骨骼所有层级、未重定向动画。来预览重定向效果和对比重定向骨骼。  

为什么Pelvis要设为`AnimationScaled`，而其它身体骨骼设为`Skeleton`就可以？  
`Skeleton`模式时骨骼平移来自于目标骨架，常规动画不会改变骨骼长度，因此用骨架默认的骨骼平移也就行了。但是Pelvis是身体的第一根骨骼，它连接的Root实质代表地面支点。因此动画是会修改Pelvis的骨骼长度的。如果也设为`Skeleton`，就失去了动画中可能存在的运动时角色的高低起伏了。

三种重定向方式：  
. **Animation** 骨骼平移来自动画数据，不做改变。
. **Skeleton** 骨骼平移来自目标骨架的绑定姿势。
. **AnimationScaled** 骨骼平移来自动画数据，但按骨架的比例调整。这是目标骨架（播放动画的骨架）与源骨架（制作动画的骨架）的骨骼长度之比。  

### 从网格复制姿态
在相似的骨架间复制动画
#### 实操 
在动画蓝图的动画图表中，使用`Copy Pose From Mesh`节点，来从另一个蒙皮网格上复制姿态数据，前提是两者的骨骼层级一致。如果源网格是目标网格的父级，此节点可以钩选`Use Attached Parent`。  

### 重定向人体模型
使用IK绑定和IK重定向器，在两个人体模型间重定向。
#### 实操
首先的，在目标动画图表中，使用了`Retarget Pose From Mesh`节点，来从源网格复制动画，该节点需设置源网格和IK重定向器。  
（使用此节点意在展示运行时重定向，因为没有导出重定向后新的动画资产，可以用于运行时两个角色网格显隐切换，但复用同一个动画）  
重点在于IK重定向器，这是一种可创建的资产，在它的细节面板中可以设置源和目标IK绑定。它的作用是关联映射两个IK绑定资产，还可以设置重定向时的姿态。（两个网格姿态相似，重定向效果才会好）  
更进一步的，是IK绑定，IK绑定也是一种可创建的、依赖具体骨架的资产，重定向只使用它的创建骨骼链的功能，每个骨骼链标识了一段骨骼层级。两个IK绑定创建相同的骨骼链后，可用于重定向。
重定向效果调好后，可以在重定向器的`Asset Browser`中选择动画导出，成为新的重定向动画，这也即是离线重定向。  

### 在不同骨架间重定向
使用IK Rig（IK绑定）和IK Retargeter（IK重定向器）进行重定向。
#### 实操
和上面类似，但是在重定向器里，创建了新的目标姿态，并编辑了骨骼参数以调整到相似姿态。  
另外UE5.6的重定向器新增了个Op Stack，还不理解。  

### 重定向的阶段
重定向根->FK重定向->IK重定向  
首先，它向重定向的根传递运动。然后，它在所有映射的骨骼链上进行插值的FK重定向。最后，从IK绑定中的IK解算器上应用IK重定向。
#### 实操
从示例可以看出，上述步骤对应着Op Stack中的各个执行块。  

1. **Pelvis Motion** 重定向根
2. **Retarget FK Chains** FK重定向
6. **Run IK Rig** 好像是一个组
3.. **Stride Warp IK Goals** IK重定向步骤-步幅扭曲功能，这允许操控重定向的动画的步幅长度、宽度和外翻度。步幅扭曲要求你使用重定向的IK目标来设置角色。
4.. **Retarget IK Goals** IK重定向步骤
5.. **Speed Plant IK Goals** 快速栽植工作流程解决滑步问题。
7. **Pole Vector Alignment** 极矢量对齐，控制目标链的扭曲。

基本上，Op Stack就是以前的全局设置和链设置。细节还有待进一步学习。  


### 重定向姿态
摆放角色的姿态以适合重定向。
#### 实操
在重定向器的层级窗口可以创建新的姿态，并编辑骨骼以适配源姿态。  
在Op Stack的`Retarget IK Goals`模块中，可以选中某个目标链，并调整其混合与偏移。  

### 编辑重定向根
升\降重定向的根
#### 实操
